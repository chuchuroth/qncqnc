<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 900 620" font-family="'Courier New', monospace">
  <defs>
    <filter id="shadow" x="-2%" y="-2%" width="104%" height="104%">
      <feDropShadow dx="2" dy="2" stdDeviation="3" flood-opacity="0.15"/>
    </filter>
  </defs>

  <!-- Background -->
  <rect width="900" height="620" fill="#0f1419" rx="8"/>

  <!-- Title -->
  <text x="450" y="35" text-anchor="middle" fill="#e2e8f0" font-size="18" font-weight="bold">ESP32-2432S028R — Gripper Controller Architecture</text>
  <line x1="100" y1="48" x2="800" y2="48" stroke="#2d3748" stroke-width="1"/>

  <!-- ========== ESP32 Board ========== -->
  <rect x="220" y="70" width="460" height="380" rx="12" fill="#1a2332" stroke="#3b82f6" stroke-width="2" filter="url(#shadow)"/>
  <text x="450" y="95" text-anchor="middle" fill="#60a5fa" font-size="14" font-weight="bold">ESP32-2432S028R</text>
  <text x="450" y="112" text-anchor="middle" fill="#64748b" font-size="10">ESP32-WROOM-32 · 240MHz · 520KB SRAM · 4MB Flash</text>

  <!-- Core 0 -->
  <rect x="240" y="125" width="200" height="160" rx="8" fill="#1e293b" stroke="#f59e0b" stroke-width="1.5"/>
  <text x="340" y="145" text-anchor="middle" fill="#fbbf24" font-size="11" font-weight="bold">CORE 0</text>

  <!-- Modbus Task -->
  <rect x="255" y="155" width="170" height="55" rx="6" fill="#292524" stroke="#ef4444" stroke-width="1"/>
  <text x="340" y="173" text-anchor="middle" fill="#fca5a5" font-size="10" font-weight="bold">modbusTask</text>
  <text x="340" y="186" text-anchor="middle" fill="#a8a29e" font-size="8">Priority 3 · 100ms poll</text>
  <text x="340" y="200" text-anchor="middle" fill="#78716c" font-size="8">modbus_rtu_esp32.cpp</text>

  <!-- MQTT Task -->
  <rect x="255" y="218" width="170" height="55" rx="6" fill="#292524" stroke="#8b5cf6" stroke-width="1"/>
  <text x="340" y="236" text-anchor="middle" fill="#c4b5fd" font-size="10" font-weight="bold">mqttTask (optional)</text>
  <text x="340" y="249" text-anchor="middle" fill="#a8a29e" font-size="8">Priority 1 · 500ms</text>
  <text x="340" y="263" text-anchor="middle" fill="#78716c" font-size="8">mqtt_publisher.cpp</text>

  <!-- Core 1 -->
  <rect x="460" y="125" width="200" height="160" rx="8" fill="#1e293b" stroke="#10b981" stroke-width="1.5"/>
  <text x="560" y="145" text-anchor="middle" fill="#34d399" font-size="11" font-weight="bold">CORE 1</text>

  <!-- GUI Task -->
  <rect x="475" y="155" width="170" height="115" rx="6" fill="#292524" stroke="#06b6d4" stroke-width="1"/>
  <text x="560" y="173" text-anchor="middle" fill="#67e8f9" font-size="10" font-weight="bold">guiTask</text>
  <text x="560" y="186" text-anchor="middle" fill="#a8a29e" font-size="8">Priority 2 · 5ms tick</text>
  <text x="560" y="203" text-anchor="middle" fill="#78716c" font-size="8">LVGL + TFT_eSPI</text>
  <text x="560" y="216" text-anchor="middle" fill="#78716c" font-size="8">dashboard.cpp</text>
  <text x="560" y="233" text-anchor="middle" fill="#78716c" font-size="8">XPT2046 touch</text>
  <text x="560" y="250" text-anchor="middle" fill="#78716c" font-size="8">320×240 ILI9341</text>

  <!-- Shared State -->
  <rect x="320" y="300" width="260" height="50" rx="6" fill="#1c1917" stroke="#eab308" stroke-width="1.5" stroke-dasharray="5,3"/>
  <text x="450" y="320" text-anchor="middle" fill="#facc15" font-size="10" font-weight="bold">GripperState (mutex-guarded)</text>
  <text x="450" y="335" text-anchor="middle" fill="#a8a29e" font-size="8">position · force · speed · state · online</text>

  <!-- Arrows: Modbus → State -->
  <line x1="340" y1="210" x2="400" y2="300" stroke="#ef4444" stroke-width="1.5" marker-end="url(#arrowRed)"/>
  <!-- Arrows: State → GUI -->
  <line x1="520" y1="300" x2="560" y2="270" stroke="#06b6d4" stroke-width="1.5" marker-end="url(#arrowCyan)"/>
  <!-- Arrows: State → MQTT -->
  <line x1="380" y1="300" x2="340" y2="273" stroke="#8b5cf6" stroke-width="1.5" marker-end="url(#arrowPurple)"/>

  <!-- Arrow markers -->
  <defs>
    <marker id="arrowRed" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><path d="M0,0 L8,3 L0,6" fill="#ef4444"/></marker>
    <marker id="arrowCyan" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><path d="M0,0 L8,3 L0,6" fill="#06b6d4"/></marker>
    <marker id="arrowPurple" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><path d="M0,0 L8,3 L0,6" fill="#8b5cf6"/></marker>
    <marker id="arrowGreen" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><path d="M0,0 L8,3 L0,6" fill="#10b981"/></marker>
    <marker id="arrowOrange" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><path d="M0,0 L8,3 L0,6" fill="#f59e0b"/></marker>
    <marker id="arrowWhite" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><path d="M0,0 L8,3 L0,6" fill="#94a3b8"/></marker>
  </defs>

  <!-- ========== UART2 / RS485 Interface ========== -->
  <rect x="240" y="365" width="180" height="70" rx="6" fill="#1e293b" stroke="#f59e0b" stroke-width="1"/>
  <text x="330" y="385" text-anchor="middle" fill="#fbbf24" font-size="10" font-weight="bold">UART2 (HW RS485)</text>
  <text x="330" y="400" text-anchor="middle" fill="#a8a29e" font-size="8">TX: GPIO 22 → DI</text>
  <text x="330" y="412" text-anchor="middle" fill="#a8a29e" font-size="8">RX: GPIO 27 ← RO</text>
  <text x="330" y="424" text-anchor="middle" fill="#a8a29e" font-size="8">DE/RE̅: GPIO 32</text>

  <!-- WiFi -->
  <rect x="480" y="365" width="180" height="70" rx="6" fill="#1e293b" stroke="#8b5cf6" stroke-width="1"/>
  <text x="570" y="385" text-anchor="middle" fill="#c4b5fd" font-size="10" font-weight="bold">WiFi 802.11 b/g/n</text>
  <text x="570" y="400" text-anchor="middle" fill="#a8a29e" font-size="8">MQTT Client</text>
  <text x="570" y="412" text-anchor="middle" fill="#a8a29e" font-size="8">Topic: qnc/modbus/</text>
  <text x="570" y="424" text-anchor="middle" fill="#a8a29e" font-size="8">device_state</text>

  <!-- ========== External: RS485 Module ========== -->
  <rect x="30" y="480" width="180" height="70" rx="8" fill="#1a2332" stroke="#f59e0b" stroke-width="2" filter="url(#shadow)"/>
  <text x="120" y="505" text-anchor="middle" fill="#fbbf24" font-size="11" font-weight="bold">RS485 Transceiver</text>
  <text x="120" y="520" text-anchor="middle" fill="#a8a29e" font-size="9">MAX3485 / XY-017</text>
  <text x="120" y="535" text-anchor="middle" fill="#78716c" font-size="8">3.3V native · 120Ω term</text>

  <!-- Arrow: UART → RS485 Module -->
  <path d="M 330 435 L 330 460 L 120 460 L 120 480" fill="none" stroke="#f59e0b" stroke-width="1.5" marker-end="url(#arrowOrange)"/>

  <!-- ========== External: Gripper ========== -->
  <rect x="30" y="560" width="180" height="50" rx="8" fill="#1a2332" stroke="#ef4444" stroke-width="2" filter="url(#shadow)"/>
  <text x="120" y="582" text-anchor="middle" fill="#fca5a5" font-size="11" font-weight="bold">DH Gripper</text>
  <text x="120" y="598" text-anchor="middle" fill="#a8a29e" font-size="9">Modbus RTU Slave ID 1</text>

  <!-- Arrow: RS485 → Gripper -->
  <line x1="120" y1="550" x2="120" y2="560" stroke="#ef4444" stroke-width="2" marker-end="url(#arrowRed)"/>
  <!-- Bus labels -->
  <text x="145" y="558" fill="#78716c" font-size="8">A / B / GND</text>

  <!-- ========== External: MQTT Broker ========== -->
  <rect x="430" y="500" width="180" height="55" rx="8" fill="#1a2332" stroke="#8b5cf6" stroke-width="2" filter="url(#shadow)"/>
  <text x="520" y="522" text-anchor="middle" fill="#c4b5fd" font-size="11" font-weight="bold">MQTT Broker</text>
  <text x="520" y="540" text-anchor="middle" fill="#a8a29e" font-size="9">Mosquitto / Cloud</text>

  <!-- Arrow: WiFi → MQTT Broker -->
  <line x1="570" y1="435" x2="570" y2="470" stroke="#8b5cf6" stroke-width="1.5" stroke-dasharray="5,3"/>
  <path d="M 570 470 L 570 478 L 520 478 L 520 500" fill="none" stroke="#8b5cf6" stroke-width="1.5" stroke-dasharray="5,3" marker-end="url(#arrowPurple)"/>
  <text x="590" y="465" fill="#64748b" font-size="8">WiFi</text>

  <!-- ========== External: NeuraSync Bridge ========== -->
  <rect x="660" y="500" width="200" height="55" rx="8" fill="#1a2332" stroke="#64748b" stroke-width="1.5" stroke-dasharray="4,3" filter="url(#shadow)"/>
  <text x="760" y="522" text-anchor="middle" fill="#94a3b8" font-size="11" font-weight="bold">MQTT→DDS Bridge</text>
  <text x="760" y="540" text-anchor="middle" fill="#64748b" font-size="9">Linux · NeuraSync Dashboard</text>

  <!-- Arrow: MQTT → Bridge -->
  <line x1="610" y1="527" x2="660" y2="527" stroke="#64748b" stroke-width="1.5" stroke-dasharray="4,3" marker-end="url(#arrowWhite)"/>

  <!-- ========== Display representation ========== -->
  <rect x="700" y="70" width="170" height="130" rx="6" fill="#0f172a" stroke="#06b6d4" stroke-width="2" filter="url(#shadow)"/>
  <text x="785" y="90" text-anchor="middle" fill="#67e8f9" font-size="10" font-weight="bold">2.8" TFT Display</text>
  <rect x="712" y="98" width="146" height="90" rx="3" fill="#0c0a09"/>
  <!-- Mini dashboard mockup -->
  <text x="720" y="112" fill="#34d399" font-size="7" font-weight="bold">● ONLINE</text>
  <text x="720" y="124" fill="#a8a29e" font-size="6">State: READY</text>
  <rect x="720" y="130" width="80" height="6" rx="2" fill="#292524"/>
  <rect x="720" y="130" width="58" height="6" rx="2" fill="#3b82f6"/>
  <text x="805" y="136" fill="#64748b" font-size="6">725</text>
  <rect x="720" y="140" width="80" height="6" rx="2" fill="#292524"/>
  <rect x="720" y="140" width="36" height="6" rx="2" fill="#f59e0b"/>
  <text x="805" y="146" fill="#64748b" font-size="6">45%</text>
  <rect x="720" y="153" width="40" height="12" rx="2" fill="#1e293b" stroke="#10b981" stroke-width="0.5"/>
  <text x="740" y="162" text-anchor="middle" fill="#34d399" font-size="6">OPEN</text>
  <rect x="765" y="153" width="40" height="12" rx="2" fill="#1e293b" stroke="#ef4444" stroke-width="0.5"/>
  <text x="785" y="162" text-anchor="middle" fill="#fca5a5" font-size="6">CLOSE</text>
  <rect x="810" y="153" width="40" height="12" rx="2" fill="#1e293b" stroke="#3b82f6" stroke-width="0.5"/>
  <text x="830" y="162" text-anchor="middle" fill="#60a5fa" font-size="6">SET</text>
  <text x="720" y="180" fill="#475569" font-size="6">Touch: XPT2046</text>

  <!-- Arrow: GUI → Display -->
  <line x1="660" y1="200" x2="700" y2="160" stroke="#06b6d4" stroke-width="1.5" stroke-dasharray="3,2" marker-end="url(#arrowCyan)"/>

  <!-- Legend -->
  <rect x="700" y="220" width="170" height="105" rx="6" fill="#1e293b" stroke="#334155" stroke-width="1"/>
  <text x="785" y="240" text-anchor="middle" fill="#94a3b8" font-size="9" font-weight="bold">Legend</text>
  <line x1="715" y1="253" x2="735" y2="253" stroke="#ef4444" stroke-width="2"/>
  <text x="742" y="257" fill="#a8a29e" font-size="8">Modbus RTU</text>
  <line x1="715" y1="268" x2="735" y2="268" stroke="#06b6d4" stroke-width="2"/>
  <text x="742" y="272" fill="#a8a29e" font-size="8">GUI / Display</text>
  <line x1="715" y1="283" x2="735" y2="283" stroke="#8b5cf6" stroke-width="2" stroke-dasharray="4,2"/>
  <text x="742" y="287" fill="#a8a29e" font-size="8">MQTT (optional)</text>
  <line x1="715" y1="298" x2="735" y2="298" stroke="#eab308" stroke-width="2" stroke-dasharray="4,2"/>
  <text x="742" y="302" fill="#a8a29e" font-size="8">Shared State</text>
  <line x1="715" y1="313" x2="735" y2="313" stroke="#64748b" stroke-width="1.5" stroke-dasharray="4,2"/>
  <text x="742" y="317" fill="#a8a29e" font-size="8">NeuraSync bridge</text>
</svg>
